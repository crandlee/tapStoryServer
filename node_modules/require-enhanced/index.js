'use strict';

//var cacheService = require('../../server/services/caching/cacheService');
var requireShortcuts = require('../../server/config/require-shortcuts.json');
var _ = require('lodash');

//RL - This is a project specific module
//There is currently some code commented out that was the beginnings of using a redis
//db to store the routes instead of loading them into memory.  I will re-look at this
//later because we are using async code for this and not sure how this will work with require

//function initializeRequireShortcuts(routePrefix) {
//
//    if (!requireShortcuts) requireShortcuts = require('../../server/config/require-shortcuts.json');
//    return cacheService.updateFromArray(requireShortcuts, { withPrefix: routePrefix, deletePrefixFirst: true });
//
//}

var path = require('path');

module.exports = function(opts) {

    opts = opts || {};

    var routePrefix = 'route-';
    global.rootPath = path.normalize(__dirname + '/../../');
    global.requirePath = rootPath + 'server/';
    global.rootRequire = function(key) {
        var routePath = _.find(requireShortcuts, { 'k': key });
        if (routePath)
            return require(requirePath + routePath.v);
        else
            throw new Error('Cannot find the require path designated by ' + key);
    };
    global.getRoutePathFromKey = function() {
        var key = arguments[0] || null;
        var args = Array.prototype.slice.call(arguments, 1);
        var routePath = _.find(requireShortcuts, { 'k': key });
        if (routePath) {
            return requirePath + routePath.v;
        }
        else
            throw new Error('Cannot find the require path designated by ' + key);
    };

    //Set up some requires that will be used all over the place
    global.Promise = require('q');
    global._ = require('lodash');
    global.env = process.env.NODE_ENV = process.env.NODE_ENV || 'development';
    global.extend = require('extend');
    global.config = global.rootRequire('cfg-config')[global.env];
    global.errSvc = global.rootRequire('svc-error');
    global.promiseUtils = global.rootRequire('svc-promise');

    //Test requires
    if (opts.test) {
        global.chai = require('chai');
        global.should = chai.should();
        global.chaiAsPromised = require('chai-as-promised');
        global.chai.use(global.chaiAsPromised);
        global.sinon = require('sinon');
        global.proxyquire = require('proxyquire');
        global.testUtils = global.rootRequire('util-test');
    }

//    initializeRequireShortcuts(routePrefix)
//        .then(function() {
//
//            //Set up a small number of globals that mostly help requiring and paths
//            //NOTE: The following functions return a promise that will get resolved
//            //after the key has been looked up in redis
//            global.rootRequire = function(key) {
//                return cacheService.getKey(routePrefix + key)
//                    .then(function(routePath) {
//                        return require(requirePath + routePath);
//                    })
//            };
//            global.rootProxyquire = function() {
//                var key = arguments[0] || null;
//                var args = Array.prototype.slice.call(arguments, 1);
//                return cacheService.getKey(routePrefix + key)
//                    .then(function(routePath) {
//                        return proxyquire(requirePath + routePath, args);
//                    })
//            };
//
//        })
//        .fail(function(err) {
//
//            console.log('There was a problem adding route keys: ' + err);
//        })
//        .finally(function() {
//
//            requireShortcuts = null;
//
//        })
//        .done();





};