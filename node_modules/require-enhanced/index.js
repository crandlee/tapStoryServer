'use strict';

//var cacheService = require('../../server/services/caching/cacheService');
var requireShortcuts = require('../../server/config/require-shortcuts.json');
var _ = require('lodash');

//RL - This is a project specific module
//There is currently some code commented out that was the beginnings of using a redis
//db to store the routes instead of loading them into memory.  I will re-look at this
//later because we are using async code for this and not sure how this will work with require

//function initializeRequireShortcuts(routePrefix) {
//
//    if (!requireShortcuts) requireShortcuts = require('../../server/config/require-shortcuts.json');
//    return cacheService.updateFromArray(requireShortcuts, { withPrefix: routePrefix, deletePrefixFirst: true });
//
//}


module.exports = function() {

    var routePrefix = 'route-';
    global.rootPath = __dirname + '/../../';
    global.requirePath = rootPath + 'server/';

//    initializeRequireShortcuts(routePrefix)
//        .then(function() {
//
//            //Set up a small number of globals that mostly help requiring and paths
//            //NOTE: The following functions return a promise that will get resolved
//            //after the key has been looked up in redis
//            global.rootRequire = function(key) {
//                return cacheService.getKey(routePrefix + key)
//                    .then(function(routePath) {
//                        return require(requirePath + routePath);
//                    })
//            };
//            global.rootProxyquire = function() {
//                var key = arguments[0] || null;
//                var args = Array.prototype.slice.call(arguments, 1);
//                return cacheService.getKey(routePrefix + key)
//                    .then(function(routePath) {
//                        return proxyquire(requirePath + routePath, args);
//                    })
//            };
//
//        })
//        .fail(function(err) {
//
//            console.log('There was a problem adding route keys: ' + err);
//        })
//        .finally(function() {
//
//            requireShortcuts = null;
//
//        })
//        .done();

    global.rootRequire = function(key) {
        var routePath = _.find(requireShortcuts, { 'k': key });
        if (routePath)
            return require(requirePath + routePath.v);
        else
            throw new Error('Cannot find the require path designated by ' + key);
    };
    global.getRoutePathFromKey = function() {
        var key = arguments[0] || null;
        var args = Array.prototype.slice.call(arguments, 1);
        var routePath = _.find(requireShortcuts, { 'k': key });
        if (routePath) {
            return requirePath + routePath.v;
        }
        else
            throw new Error('Cannot find the require path designated by ' + key);
    };


};